\NeedsTeXFormat{LaTeX2e}[2018/03/11]
\ProvidesPackage{dmlb}[a tryhard logbook for diabetes]
% PACKAGAES ===========================
   \RequirePackage[table]{xcolor}
   \RequirePackage{caption}
      \DeclareCaptionFormat{myformat}{\rmfamily\small\textsc{#1}#2{#3}}
      \captionsetup{format={myformat},labelsep={period}}
   \RequirePackage{
      xparse,
      etoolbox,
      microtype,
      xstring,
      longtable,
      array,
      multicol,
      multirow,
      rotating,
   }
   \RequirePackage[
      unicode=true,
      bookmarks=true,                 % show bookmarks bar?
      bookmarksopen=false,            % expand bookmark tree
      unicode=true,                   % non-Latin characters in pdfviewer's bookmarks
      pdftoolbar=true,                % show pdfviewer's toolbar?
      pdfmenubar=true,                % show pdfviewer's menu?
      pdffitwindow=false,             % window fit to page when opened
      pdfstartview={FitH},            % fits the width of the page to the window
      pdftitle={Diabetes Logbook},    % title
      pdfauthor={},                   % author
      pdfnewwindow=true,              % links in new PDF window
      colorlinks=false,               % false: boxed links; true: colored links
      linkcolor=red,                  % color of internal links (change box color with linkbordercolor)
      citecolor=green,                % color of links to bibliography
      filecolor=magenta,              % color of file links
      urlcolor=cyan,                  % color of external links
      % hidelinks=false
      ]{hyperref}
   \RequirePackage{fancyhdr}
      \pagestyle{fancy}
      \lhead{Diabetes Logbook}
      \rhead{p.~\thepage}
      \cfoot{}
      \renewcommand{\headrulewidth}{0.8pt}
      \renewcommand{\footrulewidth}{0.8pt}
   \RequirePackage{bookmark}
   \ExplSyntaxOn
   \sys_if_engine_pdftex:T
   {
      \RequirePackage[english]{babel}
      \renewcommand{\sfdefault}{pag}% qag
   }
   \sys_if_engine_xetex:T
   {
      \RequirePackage{polyglossia}
         \setdefaultlanguage{english}
      \RequirePackage{fontspec}
         \setmainfont{XCharter}[Ligatures=TeX]% XCharter, Crimson
         \setsansfont{Century Gothic}[Ligatures=TeX]
   }
   \ExplSyntaxOff
% PACKAGE OPTIONS =====================
   \DeclareOption{gray}{%
      % ROWS
      \providecolor{oddRowColor}{gray}{0.80}
      \providecolor{evenRowColor}{gray}{1}
      % TEXT
      \providecolor{evenRowTextColor}{gray}{0}
      \providecolor{oddRowTextColor}{gray}{0}
      % LINES
      \providecolor{tableColor}{gray}{0}
      % FANCYHDR HEADER AND FOOTER
      \providecolor{headerColor}{gray}{0.15}
   }

   \DeclareOption{graph}{%
      \AtEndPreamble{%
         \usepackage{
            pgf,
            pgfplots,
            pgfplotstable,
         }
         \usepgfplotslibrary{dateplot}%
         \pgfplotsset{%
            compat=1.16,% 
            width=\dicklength,% 
            height=\nutradius,% 
            grid=both,%
            every major grid/.append style={line width=.6pt},%
            every minor grid/.append style={line width=.4pt},%
            enlarge x limits=0.005,
            % enlarge x limits={value=-0.03285,upper},% ONLY REL VALUE REDUCTION POSSIBLE- HOW TO ENLARGE BY (IDATE+FDATE-0.03285)/(IDATE+FDATE) ???
            enlarge y limits=auto,%
            colormap={mycm}{% NONUNIFORM DISTANCES CHOSEN TO HIGHLIGHT LOW-OPTIMAL-HIGH BG
               color(1.3)=(blue!70), color(2.5)=(teal!70),%
               color(4.5)=(green), color(7)=(yellow),%
               color(10)=(red), color(23)=(magenta)},%
            my style/.style={font=\footnotesize},%
            date coordinates in=x,%
            minor x tick num=1,%
            ymin=1,%
            ytick distance=1,%
            y coord trafo/.code={\pgfmathparse{#1-(\mya-1)/\mya*(#1-\myb)*(#1>\myb)}},%
            y coord inv trafo/.code={\pgfmathparse{#1+(\mya-1)*(#1-\myb)*(#1>\myb)}},%
            % yticklabel={\pgfmathparse{int(\tick)}\pgfmathprintnumber{\tick}},%  
            % extra y ticks={10,11,12,13,14,15,16,17},% extra grid lines or just increased tick distance?
            % yticklabel={\pgfmathparse{int(\tick)}% which ticks show have a gridline but no number (overlapping)
               % \ifnum\pgfmathresult=10          
               % \else
               % \ifnum\pgfmathresult=11
               % \else
               % \ifnum\pgfmathresult=12
               % \else
               % \ifnum\pgfmathresult=13
               % \else
               % \ifnum\pgfmathresult=14
               % \else
               % \ifnum\pgfmathresult=15
               % \else
               % \ifnum\pgfmathresult=16
               % \else
               % \ifnum\pgfmathresult=17
               %  \else
            % \pgfmathprintnumber{\tick}
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
            % },
            table/col sep=comma,%
            xticklabel={\day.\month.},%
            x tick label style={%
               rotate=38,%
               anchor=east,%
               },%
            xlabel style={%
               font={\large},
               xshift={\dimexpr\dicklength*19/40\relax},% HORIZ;
               yshift={\dimexpr\nutradius*7/8\relax},% VERT; POS/NEG=UP/DOWN
               },%
            ylabel style={%
               font={\rmfamily},
            }
         }%
         \usetikzlibrary{external}%
         \tikzexternalize[%
            prefix=\myRelPath,%
            verbose=false,%
         ]%
      }%
      \AtEndDocument{%
         % \tikzset{external/force remake}%
         \centering%
         \label{dickweed}%
         \pdfbookmark[0]{Graphs}{dickweed}%
         \dmlb@graph{}%
      }
   }

   \ExecuteOptions{gray}
   \ProcessOptions\relax
% COUNTERS ============================
   % SWITCHES FOR ROW/DATE BG AND TEXT COLORS
   \newbool{dmlb@rcc}
   \newbool{dmlb@rc}
   % LONGTABLEROW FOR HYPERREF TO LABEL ROWS
   \newcounter{dmlb@dateLabel}
   % MULTIROW LENGTH AND PAGE ROWCOUND
   \newcount\dmlb@mrow
   \newcount\row
   % CURRENT ROW TEXTHEIGHTS
   \newcount\dmlb@potato 
   \newcount\dmlb@couch
   % DATE
   \newcount\year
   \newcount\month
   \newcount\day
   \newbool{@leap}
   % DATA SWITCHES/COUNTERS
   \newcounter{dmlb@dataSet}
   \newbool{dmlb@openDatFile}
   \newbool{dmlb@readPeriod}
   \newbool{dmlb@doneReading}
   % FILE INPUT
   \newcounter{dmlbYY}
   \newcounter{dmlbMM}[dmlbYY]
% COMMANDS ============================
\newcommand{\autoFileInput}[1]{% RELATIVE PATHFILE AS ARG
   \IfFileExists{#1\TwoDigits{\thedmlbYY}-\TwoDigits{\thedmlbMM}}%
   {%
      \input{#1\TwoDigits{\thedmlbYY}-\TwoDigits{\thedmlbMM}}%
      \ifnum\thedmlbMM=12 
         \stepcounter{dmlbYY}%
      \fi
      \stepcounter{dmlbMM}%
      \autoFileInput{#1}%
   }%
   {}%
}

\NewDocumentCommand \dmlbSetDate { m m m O{} } {% (RE)SETS DATE TO ANY YEAR, MONTH AND/OR DAY; OPT AUTO FILE INPUT IN `YY-MM` FORM FROM GIVEN/CURRENT DATE ONWARDS IN REL PATH `#4`; ALL ENTRIES AFTER LAST DDATE IN LAST INPUT FILE GETS THE NEW DATE- FIX BY HAVING ALL FILES END WITH ENTRY W/ DDATE, I.E. ALL ENTRIES FROM THAT DATE; FIXME? IF SUCH DATE GIVEN SUCH THAT NEW LABELS OVERLAP WITH OLD ONES, REFERENCES/BOOKMARKS ARE FUCKED
   % \newcommand{\iflabelexists}[3]{\ifcsundef{r@#1}{#3}{#2}}-- POSSIBLE FIX, #3 IS THE ABOVE CASE
   \if\relax\detokenize{#1}\relax
   \else
      \global\year #1\relax
      \StrGobbleLeft{\the\year}{2}[\syear]%
      \xdef\syear{\syear}%
      % LEAP YEAR?
      \ifnum\numexpr(\year-(\year/4)*4)\relax=0 
         \ifnum\numexpr(\year-(\year/400)*400)\relax=0% RIP years 0--400 because of floored division- possible fix, check if >400 else branch is go into negatives and mult by -1 at end
            \global\boolfalse{@leap}% FALSE LEAP YEAR
         \else
            \global\booltrue{@leap}% TRUE LEAP YEAR
         \fi
      \else
         \global\boolfalse{@leap}%
      \fi
   \fi
   %
   \if\relax\detokenize{#2}\relax
   \else
      \global\month #2\relax%
   \fi
   %
   \if\relax\detokenize{#3}\relax
   \else
      \global\day #3\relax%
   \fi
   % IF 1,2,3 EMPTY ROW GETS SAME LABEL REASSIGNED`
   \dmlb@rowlabel{\dmlb@Date}%
   %
   \if\relax\detokenize{#1}\relax
   \else
      \pdfbookmark{\the\year}{\dmlb@Date}%
   \fi
   %
   \if\relax\detokenize{#2}\relax
   \else
      \pdfbookmark[1]{\monthn@me}{\dmlb@Date}%
   \fi
   %
   \if\relax\detokenize{#4}\relax
   \else
      \setcounter{dmlbYY}{\syear}%
      \setcounter{dmlbMM}{\month}%
      \autoFileInput{#4}%
   \fi
}

\newcommand{\dmlb@rowlabel}[1]{\refstepcounter{dmlb@dateLabel}\label{#1}}

\NewDocumentCommand {\dmlb@ddate} { s } {% INCREMENTS DATE, ROW LABEL, PDF BOOKMARK, PRINTS DATE IF ENOUGH ROOM
   \small%
   \ifbool{dmlb@rcc}%
      {\color{oddRowTextColor}\global\boolfalse{dmlb@rcc}}%
      {\color{evenRowTextColor}\global\booltrue{dmlb@rcc}}%
   \ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>2% ROOM FOR DATE?
      \ifnum\dmlb@mrow=1
         % \multirow{-\strip@pt\dimexpr\dmlb@potato pt/2\relax}{*}{\rotatebox{90}{\TwoDigits{\the\day}--\TwoDigits{\the\month}\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 --\syear\fi}}%
         \multirow{-\strip@pt\dimexpr\dmlb@potato pt/2\relax}{*}{\rotatebox{90}{\TwoDigits{\the\day}--\TwoDigits{\the\month}\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>6 --\the\year\else\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 --\syear\fi\fi}}%
      \else
         % \multirow{-\dmlb@mrow}{*}{\rotatebox{90}{\TwoDigits{\the\day}--\TwoDigits{\the\month}\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 --\syear\fi}}%
         \multirow{-\dmlb@mrow}{*}{\rotatebox{90}{\TwoDigits{\the\day}--\TwoDigits{\the\month}\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>6 --\the\year\else\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 --\syear\fi\fi}}%
      \fi
   \fi
   \IfBooleanF{#1}{% FIXME, THERE HAS TO BE A BETTER WAY
      \ifnum\day=31
         \ifnum\month=12
            \global\advance\year 1\relax%
            \global\month 1\relax%
            \global\day 0\relax%
            \StrGobbleLeft{\the\year}{2}[\syear]%
            \xdef\syear{\syear}%
            \ifnum\numexpr(\year-(\year/4)*4)\relax=0 
               \ifnum\numexpr(\year-(\year/400)*400)\relax=0% RIP years 0--400 because of floored division
                  \global\boolfalse{@leap}% FALSE LEAP YEAR
               \else
                  \global\booltrue{@leap}% TRUE LEAP YEAR
               \fi
            \else
               \global\boolfalse{@leap}%
            \fi
            % \dmlb@rowlabel{\dmlb@sDate}%
            \pdfbookmark{\the\year}{\dmlb@sDate}%
         \else% NOT YEAR STEP REQUIRED
            \global\advance\month 1\relax
            \global\day 0\relax%
            % \dmlb@rowlabel{\dmlb@sDate}%
         \fi
         \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
      \else% NOT 31
         \ifnum\day=30
            \ifnum\month=4
               \global\advance\month 1\relax%
               \global\day 0\relax%
               % \dmlb@rowlabel{\dmlb@sDate}%
               \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
            \else
               \ifnum\month=6
                  \global\advance\month 1\relax%
                  \global\day 0\relax%
                  % \dmlb@rowlabel{\dmlb@sDate}%
                  \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
               \else
                  \ifnum\month=9
                     \global\advance\month 1\relax%
                     \global\day 0\relax%
                     % \dmlb@rowlabel{\dmlb@sDate}%
                     \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
                  \else
                     \ifnum\month=11
                        \global\advance\month 1\relax%
                        \global\day 0\relax%
                        % \dmlb@rowlabel{\dmlb@sDate}%
                        \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
                     \fi
                  \fi
               \fi
            \fi
         \else% NOT 30, IS IT FEB?
            \ifnum\month=2
               \ifbool{@leap}% IS LEAP?
               {%
                  \ifnum\day=29
                     \global\advance\month 1\relax%
                     \global\day 0\relax%
                     % \dmlb@rowlabel{\dmlb@sDate}%
                     \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
                  \fi
               }%
               {%
                  \ifnum\day=28% ISNOLEAP?
                     \global\advance\month 1\relax%
                     \global\day 0\relax%
                     \dmlb@rowlabel{\dmlb@sDate}%
                     \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
                  \fi
               }%
            \fi
         \fi
      \fi
      \global\advance\day 1\relax%
      \dmlb@rowlabel{\dmlb@Date}%
   }
   \global\dmlb@mrow 0\relax%
   &%
}

\newcommand{\dmlb@checkmedaddy}[1]{%
   \ifbool{dmlb@readPeriod}%
   {%
      \ifbool{dmlb@openDatFile}%
      {%
         \IfStrEq{\dmlb@Date}{\dmlb@fDate}%
         {%
            \immediate\closeout\data
            \global\boolfalse{dmlb@openDatFile}%
            \global\boolfalse{dmlb@readPeriod}%
         }%
         {%
            #1%
         }%
      }%
      {%
         \IfStrEq{\dmlb@Date}{\dmlb@iDate}%
         {%
            \stepcounter{dmlb@dataSet}%
            \immediate\openout\data=\myRelPath\thedmlb@dataSet.dat
            \global\booltrue{dmlb@openDatFile}%
            #1%
         }%
         {}%
      }%
   }%
   {%
      \global\read\periods to \dmlb@iDate%
      \ifeof\periods
         \global\booltrue{dmlb@doneReading}\closein\periods%
      \else
         \global\read\periods to \dmlb@fDate%
         \global\booltrue{dmlb@readPeriod}%
         \dmlb@checkmedaddy{#1}%
      \fi
   }%
}

\newcommand{\dmlb@QQ}[8][&]{%
   \ifstrequal{&}{#1}%
      {\global\advance\dmlb@mrow \dmlb@potato\relax}%
      {\global\advance\dmlb@mrow 1\relax}%
   \ifbool{dmlb@doneReading}%
      {}%
      {\dmlb@checkmedaddy{\ifblank{#3}{}{\immediate\write\data{\dmlb@Date #2, #3}}}}% FIXME
   \ifbool{dmlb@rc}%
      {\rowstyle{\color{evenRowTextColor}}\global\boolfalse{dmlb@rc}}%
      {\rowstyle{\color{oddRowTextColor}}\global\booltrue{dmlb@rc}}%
   \ifbool{dmlb@rcc}%
      {\cellcolor{oddRowColor}}%
      {\cellcolor{evenRowColor}}%
   #1% date
   #2&% time
   #3&% blood glucose
   #4&% insulin
   #5&% carbohydrates
   #6&% protein
   #7&% fat
   #8% remarks
   \color{tableColor}%
   \\%
}
\newsavebox{\dickss}
\NewDocumentCommand \QQQ { m m m m m m m s } {%
   \if\relax\detokenize{#7}\relax%
      \global\dmlb@potato 1\relax%
   \else
      \setbox0=\hbox{#7}%
      \global\dmlb@potato \dimexpr(\wd0)\relax\relax%
      \divide\dmlb@potato \dmlb@couch\relax%
      \global\advance\dmlb@potato 1\relax%
   \fi
   \global\advance\row \dmlb@potato\relax%
   \ifnum\row>\maxrows
      \global\row \dmlb@potato\relax%
      \global\dmlb@mrow 0\relax%
      \IfBooleanTF{#8}%
         {\dmlb@QQ[\dmlb@ddate]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
         {\dmlb@QQ{#1}{#2}{#3}{#4}{#5}{#6}{#7}}% ALREADY PAGEBROKEN BOTTOM
   \else
      \ifnum\row=\maxrows
         \global\row 0\relax%
         \IfBooleanTF{#8}%
            {\dmlb@QQ[\dmlb@ddate]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
            {\dmlb@QQ[\dmlb@ddate*]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}% PAGEBROKEN TOP
         \pagebreak%
      \else
         \IfBooleanTF{#8}%
            {\dmlb@QQ[\dmlb@ddate]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
            {\dmlb@QQ{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
      \fi
   \fi
}

\newcommand{\tograph}[2]{%
   \immediate\write\periods{#1}% dmlb@iDate
   \immediate\write\periods{#2}% dmlb@fDate
}

\newcommand{\dmlb@graph}{%
   \setcounter{dmlb@dataSet}{0}%
   \newread\periods
   \openin\periods=\myRelPath\thedmlb@dataSet.dat
   \read\periods to \dmlb@iDate
   \ifeof\periods
      % empty 0.dat, no \tograph instances
   \else
      \refstepcounter{dmlb@dataSet}%
      \dmlb@graphmedaddy{}%
   \fi
   \closein\periods
}

\newcommand{\dmlb@graphmedaddy}{%
   % first date read by @graph
   \read\periods to \dmlb@fDate
   \StrGobbleRight{\dmlb@iDate}{1}[\dmlb@iDate]% fixme- a better cmd to delete a single fucking space?
   \StrGobbleRight{\dmlb@fDate}{1}[\dmlb@fDate]%

   \tikzsetnextfilename{\thedmlb@dataSet}%
   \label{gr:\thedmlb@dataSet}%
   \pdfbookmark[1]{\dmlb@iDate--\dmlb@fDate}{gr:\thedmlb@dataSet}%
   \begin{tikzpicture}%
   \begin{axis}[%
      xmin=\dmlb@iDate{} 00:00,% SAVE DATA FROM FIRST DATE 00:00 TO SECOD DATE 00:00, I.E., INPUTING "2000-02-21", WOULD CAUSE IT TO COLLECT UNTIL END OF DOC
      xmax=\dmlb@fDate{} 00:00,% 
      xlabel={\rotatebox{90}{\dmlb@iDate--\dmlb@fDate}},%
      % xlabel={\rotatebox{90}{\dmlb@iDate\ref{\dmlb@iDate }--\dmlb@fDate\ref{\dmlb@fDate }}},% fixme?
   ]
      \addplot [scatter, sharp plot] table [header=false, x index=0, y index=1] {\myRelPath\thedmlb@dataSet.dat};%
      % \addplot [\dmlb@grOpts] table [header=false, x index=0, y index=1] {\myRelPath\thedmlb@dataSet.dat};% fixme options?
   \end{axis}%
   \end{tikzpicture}%
   \read\periods to \dmlb@iDate
   \ifeof\periods
      % DONT REPEAT
   \else
      \vspace{10sp}%
      \refstepcounter{dmlb@dataSet}%
      \dmlb@graphmedaddy{}%
   \fi
}

\newcommand{\monthn@me}{%
   \ifcase\month 
      \or January%
      \or Febuary%
      \or March%
      \or April%
      \or May%
      \or June%
      \or July%
      \or August%
      \or September%
      \or October%
      \or November%
      \or December%
   \fi
}

\newcommand{\dmlb@Date}{\the\year-\TwoDigits{\the\month}-\TwoDigits{\the\day} }%

\newcommand{\dmlb@sDate}{\the\year-\TwoDigits{\the\month}}%

\newcommand{\TwoDigits}[1]{\ifnum#1<10 0#1\else#1\fi}% DOESN'T WORK AS ROBUST COMMAND

\newcommand{\changestrut}{% VERTICAL ALIGNMENT OF TEXT WITHIN TABLE ROWS- EQUAL HEIGHT TO TOP AND BOTTOM \HLINE FROM A CAPITAL; TO BE USED ON ALL GLYPHS WITHOUT DESCENDERS OF USED FONT; thanks to Marcel Krüger from tex.stackexchange.com
   \setbox\strutbox\hbox{%
      \setbox0\hbox{ABCDEFGHJIKLMNOPQRSTUVWXYZabcdefhiklmnorstuvwxz.?!;:-1234567890}% 
      \skip0\dimexpr\baselineskip-\ht0-\dp0\relax%
      \vrule height\glueexpr\ht0+.5\skip0\relax depth\glueexpr\dp0+.5\skip0\relax width0pt% edit to liking
   }%
}

\newcommand{\calcmaxrows}{\chardef\maxrows=\numexpr\textheight/(\baselineskip+\arrayrulewidth)\relax}%

% APPLYING TEXT COLOR FROM CELL TO CELL WITHIN ROW
   \newcommand*{\@rowstyle}{}

   \newcommand*{\rowstyle}[1]{% sets the style of the next row
      \gdef\@rowstyle{#1}%
      \@rowstyle\ignorespaces%
   }

   \newcolumntype{=}{% resets the row style
      >{\gdef\@rowstyle{}}%
   }

   \newcolumntype{+}{% adds the current row style to the next column
      >{\@rowstyle}%
   }

% REST ================================
\AtEndPreamble{\color{headerColor}}% EXEC'D B4 DOC BEGIN OTHERWISE NADA
\AtBeginDocument{%
   \setlength\parindent{0pt}%
   \rowcolors{2}{oddRowColor}{evenRowColor}%
   \color{tableColor}% TABLE LINES AND TOP ROW
   \dmlb@couch \dimexpr\mym\relax\relax% \the\dimexpr\wd0-11cm\relax FIXME
   \sffamily%
   \footnotesize%
   \changestrut%
   \calcmaxrows%
}

\endinput

