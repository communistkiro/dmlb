\NeedsTeXFormat{LaTeX2e}[2018/02/28]
\ProvidesPackage{dmlb}[a tryhard logbook for diabetes]
% PACKAGAES ===========================
   \RequirePackage[table]{xcolor}
   \RequirePackage{caption}
      \DeclareCaptionFormat{myformat}{{\rmfamily\small\textsc{#1}#2{#3}}}
      \captionsetup{format={myformat},labelsep={period}}
   \RequirePackage{
      xparse,
      etoolbox,
      microtype,
      xstring,
      longtable,
      array,
      multicol,
      multirow,
      rotating,
   }
   \RequirePackage[
      unicode=true,
      bookmarks=true,                 % show bookmarks bar?
      bookmarksopen=false,            % expand bookmark tree
      unicode=true,                   % non-Latin characters in pdfviewer's bookmarks
      pdftoolbar=true,                % show pdfviewer's toolbar?
      pdfmenubar=true,                % show pdfviewer's menu?
      pdffitwindow=false,             % window fit to page when opened
      pdfstartview={FitH},            % fits the width of the page to the window
      pdftitle={Diabetes Logbook},    % title
      pdfauthor={},                   % author
      pdfnewwindow=true,              % links in new PDF window
      colorlinks=false,               % false: boxed links; true: colored links
      linkcolor=red,                  % color of internal links (change box color with linkbordercolor)
      citecolor=green,                % color of links to bibliography
      filecolor=magenta,              % color of file links
      urlcolor=cyan,                  % color of external links
      % hidelinks=false
      ]{hyperref}
   \RequirePackage{fancyhdr}
      \pagestyle{fancy}
      \lhead{Diabetes Logbook}
      \rhead{p.~\thepage}
      \cfoot{}
      \renewcommand{\headrulewidth}{0.8pt}
      \renewcommand{\footrulewidth}{0.8pt}
   \RequirePackage{bookmark}
   \ExplSyntaxOn
   \sys_if_engine_pdftex:T
   {
      \RequirePackage[english]{babel}
      \renewcommand{\sfdefault}{pag}% qag
   }
   \sys_if_engine_xetex:T
   {
      \RequirePackage{polyglossia}
         \setdefaultlanguage{english}
      \RequirePackage{fontspec}
         \setmainfont{XCharter}[Ligatures=TeX]% XCharter, Crimson, Rosario
         \setsansfont{Century Gothic}[Ligatures=TeX]
   }
   \ExplSyntaxOff
% PACKAGE OPTIONS =====================
   \DeclareOption{gray}{%
      % ROWS
      \providecolor{oddRowColor}{gray}{0.80}
      \providecolor{evenRowColor}{gray}{1}
      % TEXT
      \providecolor{evenRowTextColor}{gray}{0} 
      \providecolor{oddRowTextColor}{gray}{0}
      % LINES
      \providecolor{tableColor}{gray}{0}
      % FANCYHDR HEADER AND FOOTER
      \providecolor{headerColor}{gray}{0.15}
   }

   \DeclareOption{graph}{%
      \AtEndPreamble{%
         \usepackage{
            pgf,
            pgfplots,
            pgfplotstable,
         }
         \usepgfplotslibrary{dateplot}%
         \pgfplotsset{%
            compat=1.16,% 
            width=\dicklength,% 
            height=\nutradius,% 
            grid=both,%
            every major grid/.append style={line width=.6pt},%
            every minor grid/.append style={line width=.4pt},%
            enlarge x limits=0.005,
            % enlarge x limits={value=-0.03285,upper},% ONLY REL VALUE REDUCTION POSSIBLE- HOW TO ENLARGE BY (IDATE+FDATE-0.03285)/(IDATE+FDATE) ???
            enlarge y limits=auto,%
            colormap={mycm}{% NONUNIFORM DISTANCES CHOSEN TO HIGHLIGHT LOW-OPTIMAL-HIGH BG
               color(1.3)=(blue!70), color(2.5)=(teal!70),%
               color(4.5)=(green), color(7)=(yellow),%
               color(10)=(red), color(23)=(magenta)},%
            my style/.style={font=\footnotesize},%
            date coordinates in=x,%
            minor x tick num=1,%
            ymin=1,%
            ytick distance=1,%
            y coord trafo/.code={\pgfmathparse{#1-(\mya-1)/\mya*(#1-\myb)*(#1>\myb)}},%
            y coord inv trafo/.code={\pgfmathparse{#1+(\mya-1)*(#1-\myb)*(#1>\myb)}},%
            % yticklabel={\pgfmathparse{int(\tick)}\pgfmathprintnumber{\tick}},%  
            % extra y ticks={10,11,12,13,14,15,16,17},% extra grid lines or just increased tick distance?
            % yticklabel={\pgfmathparse{int(\tick)}% which ticks show have a gridline but no number (overlapping)
               % \ifnum\pgfmathresult=10          
               % \else
               % \ifnum\pgfmathresult=11
               % \else
               % \ifnum\pgfmathresult=12
               % \else
               % \ifnum\pgfmathresult=13
               % \else
               % \ifnum\pgfmathresult=14
               % \else
               % \ifnum\pgfmathresult=15
               % \else
               % \ifnum\pgfmathresult=16
               % \else
               % \ifnum\pgfmathresult=17
               %  \else
            % \pgfmathprintnumber{\tick}
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
               %  \fi
            % },
            table/col sep=comma,%
            xticklabel={\day.\month.},%
            x tick label style={%
               rotate=38,%
               anchor=east,%
               },%
            xlabel style={%
               font=\large,
               xshift={\dimexpr\dicklength*19/40\relax},% HORIZ;
               yshift={\dimexpr\nutradius*7/8\relax},% VERT; POS/NEG=UP/DOWN
               },%
         }%
         \usetikzlibrary{external}%
         \tikzexternalize[%
            prefix=\myRelPath,%
            verbose=false,%
         ]%
      }%
      \AtEndDocument{%
         % \tikzset{external/force remake}%
         \centering%
         \label{dickweed}%
         \pdfbookmark[0]{Graphs}{dickweed}%
         \dmlb@graph{}%
      }
   }

   \ExecuteOptions{gray}
   \ProcessOptions\relax
% COUNTERS ============================
   % SWITCHES FOR ROW/DATE BG AND TEXT COLORS
   \newbool{dmlb@rcc}
   \newbool{dmlb@rc}
   % LONGTABLEROW FOR HYPERREF TO LABEL ROWS
   \newcounter{dmlb@dateLabel}
   % MULTIROW LENGTH AND PAGE ROWCOUND
   \newcount\dmlb@mrow
   \newcounter{row}
   % CURRENT ROW TEXTHEIGHTS
   \newcount\dmlb@potato 
   \newcount\dmlb@couch
   % DATE COUNTERS
   \newcounter{year}
   \newcounter{month}[year]
   \newcounter{day}[month]
   % LEAP YEAR MONITOR
   \newcount\dmlb@trapsAreGay
   % DATA SWITCHES/COUNTERS
   \newcounter{dmlb@dataSet}
   \newbool{dmlb@openDatFile}
   \newbool{dmlb@readPeriod}
   \newbool{dmlb@doneReading}
   % FULE INPUT
   \newcounter{dmlbYY}
   \newcounter{dmlbMM}[dmlbYY]
% COMMANDS ============================
\NewDocumentCommand \autoFileInput { m } {% RELATIVE PATHFILE AS ARG
   \IfFileExists{#1\TwoDigits{\thedmlbYY}-\TwoDigits{\thedmlbMM}}%
   {%
      \input{#1\TwoDigits{\thedmlbYY}-\TwoDigits{\thedmlbMM}}%
      \ifnum\thedmlbMM=12 
         \stepcounter{dmlbYY}%
      \fi
      \stepcounter{dmlbMM}%
      \autoFileInput{#1}%
   }%
   {}%
}

\NewDocumentCommand \dmlbSetDate { m m m O{} } {% (RE)SETS DATE TO ANY YEAR, MONTH AND/OR DAY; OPT AUTO FILE INPUT IN `YY-MM` FORM FROM GIVEN/CURRENT DATE ONWARDS IN REL PATH `#4`; ALL ENTRIES AFTER LAST DDATE IN LAST INPUT FILE GETS THE NEW DATE- FIX BY HAVING ALL FILES END WITH ENTRY W/ DDATE, I.E. ALL ENTRIES FROM THAT DATE
   \if\relax\detokenize{#1}\relax
   \else
      \setcounter{year}{#1}%
      \StrGobbleLeft{\theyear}{2}[\syear]%
      \xdef\syear{\syear}%
   \fi
   %
   \if\relax\detokenize{#2}\relax
   \else
      \setcounter{month}{#2}%
   \fi
   %
   \if\relax\detokenize{#3}\relax
   \else
      \setcounter{day}{#3}%
   \fi
   % IF 1,2,3 EMPTY ROW GETS SAME LABEL REASSIGNED`
   \xdef\dmlb@Date{\theyear-\TwoDigits{\themonth}-\TwoDigits{\theday} }% 
   \dmlb@rowlabel{\dmlb@Date}%
   %
   \if\relax\detokenize{#1}\relax
   \else
      \pdfbookmark{\theyear}{\dmlb@Date}%
   \fi
   %
   \if\relax\detokenize{#2}\relax
   \else
      \pdfbookmark[1]{\monthn@me}{\dmlb@Date}%
   \fi
   %
   \if\relax\detokenize{#4}\relax
   \else
      \setcounter{dmlbYY}{\syear}%
      \setcounter{dmlbMM}{\themonth}%
      \autoFileInput{#4}%
   \fi
}

\NewDocumentCommand \dmlb@rowlabel { m } {\refstepcounter{dmlb@dateLabel}\label{#1}}

\NewDocumentCommand {\dmlb@ddate} { } {% INCREMENTS DATE, ROW LABEL, PDF BOOKMARK, PRINTS DATE IF ENOUGH ROOM
   \small%
   \ifbool{dmlb@rcc}%
      {\color{oddRowTextColor}\global\boolfalse{dmlb@rcc}}%
      {\color{evenRowTextColor}\global\booltrue{dmlb@rcc}}%
   \ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>2% ROOM FOR DATE?
      \ifnum\dmlb@mrow=1
         \StrGobbleRight{\the\dimexpr(\dmlb@potato pt/2-1pt)\relax}{2}[\DICK]%
         \multirow{-\DICK}{*}{\rotatebox{90}{\TwoDigits{\theday}.\TwoDigits{\themonth}.\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 \syear\fi}}%
      \else
         \multirow{-\dmlb@mrow}{*}{\rotatebox{90}{\TwoDigits{\theday}.\TwoDigits{\themonth}.\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 \syear\fi}}%
      \fi
   \fi
   \ifnum\theday=31
      \ifnum\themonth=12
         \stepcounter{year}\stepcounter{month}%
         \StrGobbleLeft{\theyear}{2}[\syear]%
         \xdef\syear{\syear}%
         \ifnum\dmlb@trapsAreGay=0
            \global\advance\dmlb@trapsAreGay -4\relax%
         \fi
         \global\advance\dmlb@trapsAreGay 1\relax%
         \dmlb@rowlabel{\dmlb@sDate}%
         \pdfbookmark{\theyear}{\dmlb@sDate}%
      \else% NOT YEAR STEP REQUIRED
         \stepcounter{month}%
         \dmlb@rowlabel{\dmlb@sDate}%
      \fi
      \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
   \else% NOT 31
      \ifnum\theday=30
         \ifnum\themonth=4
            \stepcounter{month}%
            \dmlb@rowlabel{\dmlb@sDate}%
            \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
         \else
            \ifnum\themonth=6
               \stepcounter{month}%
               \dmlb@rowlabel{\dmlb@sDate}%
               \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
            \else
               \ifnum\themonth=9
                  \stepcounter{month}%
                  \dmlb@rowlabel{\dmlb@sDate}%
                  \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
               \else
                  \ifnum\themonth=11
                     \stepcounter{month}%
                     \dmlb@rowlabel{\dmlb@sDate}%
                     \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
                  \fi
               \fi
            \fi
         \fi
      \else% NOT 30, IS IT FEB?
         \ifnum\themonth=2
            \ifnum\dmlb@trapsAreGay=0% IS LEAP?
               \ifnum\theday=29
                  \stepcounter{month}%
                  \dmlb@rowlabel{\dmlb@sDate}%
                  \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
               \fi
            \else
               \ifnum\theday=28% ISNOLEAP?
                  \stepcounter{month}%
                  \dmlb@rowlabel{\dmlb@sDate}%
                  \pdfbookmark[1]{\monthn@me}{\dmlb@sDate}%
               \fi
            \fi
         \fi
      \fi
   \fi
   \stepcounter{day}%
   \xdef\dmlb@Date{\theyear-\TwoDigits{\themonth}-\TwoDigits{\theday} }% 
   \dmlb@rowlabel{\dmlb@Date}%
   \global\dmlb@mrow 0\relax%
   &%
}

\NewDocumentCommand \dmlb@dddate { } {%
   \small%
   \ifbool{dmlb@rcc}%
      {\color{oddRowTextColor}}%
      {\color{evenRowTextColor}}%
   \ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>2% ROOM FOR DATE?
      \ifnum\dmlb@mrow=1
         \StrGobbleRight{\the\dimexpr(\dmlb@potato pt/2-1pt)\relax}{2}[\DICK]%
         \multirow{-\DICK}{*}{\rotatebox{90}{\TwoDigits{\theday}.\TwoDigits{\themonth}.\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 \syear\fi}}%
      \else
         \multirow{-\dmlb@mrow}{*}{\rotatebox{90}{\TwoDigits{\theday}.\TwoDigits{\themonth}.\ifnum\numexpr(\dmlb@mrow+\dmlb@potato-1)\relax>4 \syear\fi}}%
      \fi
   \fi
   \global\dmlb@mrow 0\relax%
   &%
}

\NewDocumentCommand \dmlb@checkmedaddy { m } {%
   \ifbool{dmlb@readPeriod}%
   {%
      \ifbool{dmlb@openDatFile}%
      {%
         \ifx\dmlb@Date\dmlb@fDate
            \immediate\closeout\data
            \global\boolfalse{dmlb@openDatFile}%
            \global\boolfalse{dmlb@readPeriod}%
         \else
            {#1}%
         \fi
      }%
      {%
         \ifx\dmlb@Date\dmlb@iDate
            \stepcounter{dmlb@dataSet}%
            \immediate\openout\data=\myRelPath\thedmlb@dataSet.dat
            \global\booltrue{dmlb@openDatFile}%
            {#1}%
         \fi
      }%
   }%
   {%
      \global\read\periods to \dmlb@iDate%
      \ifeof\periods
         \global\booltrue{dmlb@doneReading}\closein\periods%
      \else
         \global\read\periods to \dmlb@fDate%
         \global\booltrue{dmlb@readPeriod}%
         \dmlb@checkmedaddy{#1}%
      \fi
   }%
}

\NewDocumentCommand \dmlb@QQ { O{&} m m m m m m m} {%
   \ifstrequal{&}{#1}%
      {\global\advance\dmlb@mrow \dmlb@potato\relax}%
      {\global\advance\dmlb@mrow 1\relax}%
   \ifbool{dmlb@doneReading}%
      {}%
      {\dmlb@checkmedaddy{\ifblank{#3}{}{\immediate\write\data{\dmlb@Date #2, #3}}}}%
   \ifbool{dmlb@rc}%
      {\rowstyle{\color{evenRowTextColor}}\global\boolfalse{dmlb@rc}}%
      {\rowstyle{\color{oddRowTextColor}}\global\booltrue{dmlb@rc}}%
   \ifbool{dmlb@rcc}%
      {\cellcolor{oddRowColor}}%
      {\cellcolor{evenRowColor}}%
   #1% date
   #2&% time
   #3&% blood glucose
   #4&% insulin
   #5&% carbohydrates
   #6&% protein
   #7&% fat
   #8% remarks
   \color{tableColor}%
   \\%
}

\NewDocumentCommand \QQQ { m m m m m m m s } {%
   \if\relax\detokenize{#7}\relax%
      \global\dmlb@potato 1\relax%
   \else
      \setbox0=\hbox{#7}%
      \global\dmlb@potato \dimexpr(\wd0)\relax\relax%
      \divide\dmlb@potato \dmlb@couch\relax%
      \global\advance\dmlb@potato 1\relax%
   \fi
   \addtocounter{row}{\dmlb@potato}%
   \ifnum\therow>\maxrows
      \setcounter{row}{\dmlb@potato}%
      \global\dmlb@mrow 0\relax%
      \IfBooleanTF{#8}%
         {\dmlb@QQ[\dmlb@ddate]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
         {\dmlb@QQ{#1}{#2}{#3}{#4}{#5}{#6}{#7}}% ALREADY PAGEBROKEN BOTTOM
   \else
      \ifnum\therow=\maxrows
         \setcounter{row}{0}%
         \IfBooleanTF{#8}%
            {\dmlb@QQ[\dmlb@ddate]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
            {\dmlb@QQ[\dmlb@dddate]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}% PAGEBROKEN TOP
         \pagebreak%
      \else
         \IfBooleanTF{#8}%
            {\dmlb@QQ[\dmlb@ddate]{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
            {\dmlb@QQ{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
      \fi
   \fi
}

\NewDocumentCommand \tograph { m m } {%
   \immediate\write\periods{#1}% dmlb@iDate
   \immediate\write\periods{#2}% dmlb@fDate
}

\NewDocumentCommand \dmlb@graph { } {%
   \setcounter{dmlb@dataSet}{0}%
   \newread\periods
   \openin\periods=\myRelPath\thedmlb@dataSet.dat
   \read\periods to \dmlb@iDate
   \ifeof\periods
      % empty 0.dat, no \tograph instances
   \else
      \refstepcounter{dmlb@dataSet}%
      \dmlb@graphmedaddy{}%
   \fi
   \closein\periods
}

\NewDocumentCommand \dmlb@graphmedaddy { } {%
   % \IfFileExists{\myRelPath\thedmlb@dataSet.dat}% start@ 1.dat % reading peiods > reading periods *and* iffileexists?
   % {%
   % first date read by @graph
      \read\periods to \dmlb@fDate
      \StrGobbleRight{\dmlb@iDate}{1}[\dmlb@iDate]% fixme- a better cmd to delete a single fucking space?
      \StrGobbleRight{\dmlb@fDate}{1}[\dmlb@fDate]%

      \tikzsetnextfilename{\thedmlb@dataSet}%
      \label{gr:\thedmlb@dataSet}%
      \pdfbookmark[1]{\dmlb@iDate--\dmlb@fDate}{gr:\thedmlb@dataSet}%
      \begin{tikzpicture}%
      \begin{axis}[%
         xmin=\dmlb@iDate{} 00:00,% SAVE DATA FROM FIRST DATE 00:00 TO SECOD DATE 00:00;
         xmax=\dmlb@fDate{} 00:00,% I.E., INPUTING "2000-02-21", WOULD CAUSE IT TO COLLECT UNTIL END OF DOC
         xlabel={\rotatebox{90}{\dmlb@iDate--\dmlb@fDate}},%
         % xlabel={\rotatebox{90}{\dmlb@iDate\ref{\dmlb@iDate }--\dmlb@fDate\ref{\dmlb@fDate }}},% fixme?
      ]
         \addplot [scatter, sharp plot] table [header=false, x index=0, y index=1] {\myRelPath\thedmlb@dataSet.dat};%
         % \addplot [\dmlb@grOpts] table [header=false, x index=0, y index=1] {\myRelPath\thedmlb@dataSet.dat};% fixme options?
      \end{axis}%
      \end{tikzpicture}%
      \read\periods to \dmlb@iDate
      \ifeof\periods
         % DONT REPEAT
      \else
         \vspace{10sp}%
         \refstepcounter{dmlb@dataSet}%
         \dmlb@graphmedaddy{}%
      \fi
   % }%
   % {}%
}

\def\monthn@me{%
   \ifnum\themonth<7
      \ifnum\themonth=1
         January%
      \else
         \ifnum\themonth=3
            March%
         \else
            \ifnum\themonth=5
               May%
            \else
               \ifnum\themonth=4
                  April%
               \else
                  \ifnum\themonth=6
                     June%
                  \else
                     \ifnum\themonth=2
                        February%
                     \fi
                  \fi
               \fi
            \fi
         \fi
      \fi
   \else
      \ifnum\themonth=7
         July%
      \else
         \ifnum\themonth=8
            August%
         \else
            \ifnum\themonth=10
               October%
            \else
               \ifnum\themonth=12
                  December%
               \else
                  \ifnum\themonth=9
                     September%
                  \else
                     November%
                  \fi
               \fi
            \fi
         \fi
      \fi
   \fi
}

\newcommand*{\TwoDigits}[1]{\ifnum#1<10 0#1\else#1\fi}

\def\dmlb@sDate{\theyear-\TwoDigits{\themonth} }

% APPLYING TEXT COLOR FROM CELL TO CELL WITHIN ROW
   \newcommand*{\@rowstyle}{}

   \newcommand*{\rowstyle}[1]{% sets the style of the next row
      \gdef\@rowstyle{#1}%
      \@rowstyle\ignorespaces%
   }

   \newcolumntype{=}{% resets the row style
      >{\gdef\@rowstyle{}}%
   }

   \newcolumntype{+}{% adds the current row style to the next column
      >{\@rowstyle}%
   }

\NewDocumentCommand \changestrut { } {% VERTICAL ALIGNMENT OF TEXT WITHIN TABLE ROWS- EQUAL HEIGHT TO TOP AND BOTTOM \HLINE FROM A CAPITAL; TO BE USED ON ALL GLYPHS WITHOUT DESCENDERS OF USED FONT; thanks to Marcel Krüger from tex.stackexchange.com
   \setbox\strutbox\hbox{%
   \setbox0\hbox{ABCDEFGHJIKLMNOPQRSTUVWXYZabcdefhiklmnorstuvwxz.?!;:-1234567890}% 
   \skip0\dimexpr\baselineskip-\ht0-\dp0\relax%
   \vrule height\glueexpr\ht0+.5\skip0\relax depth\glueexpr\dp0+.5\skip0\relax width0pt%
   }%
}%
% REST ================================
\AtBeginDocument{%
   \setlength\parindent{0pt}%
   \rowcolors{2}{oddRowColor}{evenRowColor}%
   \color{tableColor}% TABLE LINES AND TOP ROW
   \dmlb@trapsAreGay \theyear\relax % ONE-TIME CALC FOR LEAP YEAR
   \divide\dmlb@trapsAreGay 4\relax
   \multiply\dmlb@trapsAreGay 4\relax
   \advance\dmlb@trapsAreGay -\theyear\relax
   \multiply\dmlb@trapsAreGay -1\relax
   \dmlb@couch \dimexpr\mym\relax\relax
   \sffamily%
   \footnotesize%
   \changestrut{}%
}
\AtEndPreamble{\color{headerColor}}% EXEC'D B4 DOC BEGIN OTHERWISE NADA

\endinput

